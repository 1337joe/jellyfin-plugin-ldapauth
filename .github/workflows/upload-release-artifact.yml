name: Upload release artifact

on:
  release:
    types: [ published ]

env:
  PLUGIN: ldap-authentication

jobs:
  build-upload-artifact:
    name: Build and upload artifact
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 5.0.x

      - name: Install dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Set variables
        id: set-variables
        run: |
          version=$(cat build.yaml | grep version | grep -oP [0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)
          asset_path="target/${PROJECT}.zip"
          asset_name="${PROJECT}-${version}.zip"

          echo "Version is ${version}"
          echo "Asset_Path is ${asset_path}"
          echo "Asset_Name is ${asset_name}"
          echo "::set-output name=asset-path::${asset_path}"
          echo "::set-output name=asset-name::${asset_name}"

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./${{ steps.set-variables.outputs.asset-path }}
          asset_name: ${{ steps.set-variables.outputs.asset-name }}
          asset_content_type: application/zip
